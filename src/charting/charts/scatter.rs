use plotters::{
    chart::{ChartBuilder, ChartContext},
    coord::types::RangedCoordi64,
    prelude::{Cartesian2d, Circle, DrawingBackend},
    style::Color,
};

use crate::{
    charting::{
        axis_descriptor::{AxisBestFit, AxisDescriptors},
        charts::{ChartData, resolve_axis_range},
        error::ChartConstructionError,
    },
    extract::ChartableData,
};

pub struct ScatterChart {
    x_range: (i64, i64),
    y_range: (i64, i64),
    data: Vec<(i64, i64)>,
    axis_fits: [AxisBestFit; 2],
}

impl ScatterChart {
    pub fn new(
        data: &ChartableData,
        axis_descriptors: &AxisDescriptors,
    ) -> Result<Self, ChartConstructionError> {
        let data: Vec<_> = match data {
            ChartableData::I64(items) => items.clone(),
            // _ => return Err(ChartConstructionError::IncompatibleNodeAndChartType),
        };

        let x_range = (0, data.len() as i64);
        let y_range = resolve_axis_range(&data);

        let axis_fits = [
            axis_descriptors.x.quantity.to_best_fit(),
            axis_descriptors.y.best_fit(y_range.1),
        ];

        Ok(ScatterChart {
            x_range,
            y_range,
            data: data
                .iter()
                .enumerate()
                .map(|(i, e)| (i as i64, *e))
                .collect(),
            axis_fits,
        })
    }
}

type Coords = Cartesian2d<RangedCoordi64, RangedCoordi64>;
impl ChartData<Coords> for ScatterChart {
    fn draw_into<'a, B: DrawingBackend>(
        &self,
        canvas: &mut ChartBuilder<B>,
    ) -> Result<ChartContext<'a, B, Coords>, ChartConstructionError> {
        let mut context = canvas
            .build_cartesian_2d(
                self.x_range.0..self.x_range.1,
                self.y_range.0..self.y_range.1,
            )
            .map_err(|e| ChartConstructionError::InvalidCoordinateSystem(e.to_string()))?;

        context
            .draw_series(
                self.data
                    .iter()
                    .map(|&(x, y)| Circle::new((x, y), 2, plotters::style::BLUE.filled())),
            )
            .map_err(|e| ChartConstructionError::ChartSeriesError(e.to_string()))?;

        Ok(context)
    }

    fn axis_fits(&self) -> &[AxisBestFit; 2] {
        &self.axis_fits
    }
}
